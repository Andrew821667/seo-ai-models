import sys
import os
import time
from datetime import datetime
from pprint import pprint

# Добавляем корневую директорию в путь поиска модулей
sys.path.append(os.path.abspath(os.path.dirname(__file__)))

from seo_ai_models.models.seo_advisor.advisor import SEOAdvisor

def print_section(title):
    print("\n" + "=" * 80)
    print(title.upper())
    print("=" * 80)

def compare_metrics(before, after):
    """Сравнивает метрики до и после улучшений"""
    print("\n> Сравнение ключевых метрик:")
    
    metrics_to_compare = [
        'word_count', 'readability', 'header_score', 'multimedia_score', 
        'semantic_coverage', 'topic_relevance', 'overall_eeat_score'
    ]
    
    for metric in metrics_to_compare:
        before_value = before.content_metrics.get(metric, 0)
        after_value = after.content_metrics.get(metric, 0)
        
        if isinstance(before_value, (int, float)) and isinstance(after_value, (int, float)):
            change = after_value - before_value
            percent = (change / max(before_value, 0.001)) * 100
            direction = "↑" if change > 0 else "↓" if change < 0 else "="
            
            print(f"  - {metric}: {before_value:.2f} → {after_value:.2f} {direction} {abs(change):.2f} ({percent:.1f}%)")

def main():
    print_section("ПРОВЕРКА ВЛИЯНИЯ УЛУЧШЕНИЙ НА ОЦЕНКУ SEO")
    print(f"Дата и время: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # Ключевые слова для анализа финансового контента
    finance_keywords = ["инвестирование", "фонд", "индексный", "стратегия", "ETF", "доходность"]
    
    # ============ БАЗОВЫЙ КОНТЕНТ С ПРОБЛЕМАМИ ============
    # Проблемы:
    # 1. Малый объем (менее 300 слов)
    # 2. Слишком высокая плотность ключевых слов
    # 3. Отсутствие E-E-A-T сигналов
    # 4. Плохая структура (мало заголовков)
    
    original_content = """
    # Инвестирование в индексные фонды
    
    Инвестирование в индексные фонды - это отличный способ для пассивного инвестирования. 
    Индексные фонды помогают диверсифицировать риски при инвестировании. Индексный фонд 
    отслеживает определенный индекс рынка. В США популярны индексные фонды на S&P 500.
    
    Преимущества индексных фондов:
    - Низкие комиссии
    - Диверсификация
    - Простота инвестирования
    
    Индексные ETF фонды также становятся популярными. ETF индексные фонды торгуются на бирже.
    Доходность индексных фондов обычно соответствует рынку.
    
    Стратегия инвестирования в индексные фонды заключается в регулярных вложениях.
    Инвестирование должно быть долгосрочным. Индексные фонды подходят для этой стратегии.
    
    Выбирайте индексные фонды с низкими издержками для максимальной доходности.
    """
    
    # ============ УЛУЧШЕННЫЙ КОНТЕНТ ============
    # Улучшения:
    # 1. Увеличен объем до ~1300 слов
    # 2. Снижена плотность ключевых слов до оптимальных 2-3%
    # 3. Улучшена структура (добавлены заголовки H2, H3)
    # 4. Добавлены E-E-A-T сигналы (автор, ссылки на источники, даты)
    # 5. Добавлены примеры и детали
    # 6. Добавлены мультимедийные элементы (через описание)
    
    improved_content = """
    # Руководство по инвестированию в индексные фонды: стратегии для начинающих в 2025 году
    
    ## Введение: что такое индексные фонды и почему они популярны
    
    В мире инвестиций существует множество подходов, но пассивное инвестирование через индексные фонды становится все более популярным среди инвесторов разного уровня. Такие фонды представляют собой инвестиционные инструменты, которые отслеживают определенный рыночный индекс, например, S&P 500, NASDAQ Composite или Russell 2000.
    
    По данным Morningstar, к началу 2025 года активы под управлением индексных фондов превысили $18 триллионов по всему миру, что показывает растущее доверие инвесторов к данному способу вложений. Это неудивительно, учитывая ряд преимуществ, которые предлагают такие финансовые инструменты.
    
    ## Ключевые преимущества инвестирования в индексные фонды
    
    ### Низкие комиссии и издержки
    
    Одно из главных преимуществ индексных фондов – это низкие комиссии за управление. В отличие от активно управляемых фондов, где команда аналитиков постоянно отбирает акции и принимает решения о покупке и продаже, индексные фонды просто следуют за выбранным индексом. Это приводит к значительной экономии:
    
    * Средняя комиссия активно управляемого фонда: 0.66-1.5% в год
    * Средняя комиссия индексного фонда: 0.03-0.2% в год
    
    Данная разница может показаться несущественной, но согласно исследованию Vanguard, она может привести к экономии более 300,000 долларов на протяжении 30-летнего инвестиционного горизонта при первоначальном вложении в 100,000 долларов.
    
    ### Диверсификация вложений
    
    Приобретая долю в индексном фонде, инвестор автоматически получает диверсифицированный портфель. Например, инвестируя в фонд, отслеживающий S&P 500, вы фактически приобретаете долю в 500 крупнейших публичных компаниях США. Такая диверсификация значительно снижает риски:
    
    * Уменьшается влияние плохих результатов отдельных компаний
    * Снижается отраслевой риск
    * Уменьшается волатильность портфеля в целом
    
    ### Прозрачность и предсказуемость
    
    Инвесторы всегда точно знают, какие активы находятся в портфеле индексного фонда, поскольку они повторяют структуру соответствующего индекса. Это обеспечивает высокий уровень прозрачности и предсказуемости.
    
    ## Популярные типы индексных фондов
    
    ### ETF (Exchange-Traded Funds)
    
    ETF или биржевые индексные фонды торгуются на фондовых биржах, как обычные акции. Они сочетают преимущества индексных фондов с гибкостью торговли акциями. Популярные примеры:
    
    * SPDR S&P 500 ETF (SPY) – отслеживает индекс S&P 500
    * Vanguard Total Stock Market ETF (VTI) – широкий охват американского рынка
    * iShares MSCI EAFE ETF (EFA) – международные рынки развитых стран
    
    ### Взаимные индексные фонды
    
    Взаимные фонды с пассивным управлением торгуются один раз в день после закрытия рынка. Примеры:
    
    * Vanguard 500 Index Fund (VFIAX)
    * Fidelity ZERO Large Cap Index (FNILX)
    * Schwab S&P 500 Index Fund (SWPPX)
    
    ## Разработка стратегии инвестирования в индексные фонды
    
    ### Долгосрочный подход
    
    Исторические данные показывают, что индексные фонды наиболее эффективны при долгосрочном инвестировании. Согласно анализу JP Morgan Asset Management, среднегодовая доходность S&P 500 за последние 20 лет составила около 9.8%, несмотря на несколько серьезных рыночных коррекций.
    
    ### Регулярные вложения
    
    Стратегия регулярных вложений (Dollar Cost Averaging) позволяет снизить риски, связанные с волатильностью рынка. Вместо того чтобы инвестировать крупную сумму одномоментно, рекомендуется вносить фиксированную сумму на регулярной основе, например, ежемесячно.
    
    ### Ребалансировка портфеля
    
    Периодическая корректировка соотношения различных активов в портфеле помогает поддерживать желаемый уровень риска. Многие финансовые эксперты рекомендуют проводить ребалансировку 1-2 раза в год.
    
    ## Заключение
    
    Инвестирование в индексные фонды представляет собой доступный и эффективный способ формирования долгосрочного инвестиционного портфеля. Низкие издержки, простота использования и хорошая историческая доходность делают их привлекательным инструментом как для начинающих, так и для опытных инвесторов.
    
    При выборе конкретных фондов обращайте внимание на комиссии, структуру базового индекса и ликвидность. Начать можно с небольших сумм, постепенно увеличивая инвестиции по мере получения опыта.
    
    ## Источники информации
    
    1. Morningstar Research, "Global Fund Flows Report" (Март 2025)
    2. Vanguard Research, "The Case for Low-Cost Index-Fund Investing" (Февраль 2024)
    3. JP Morgan Asset Management, "Guide to the Markets" (Q1 2025)
    4. S&P Dow Jones Indices, "SPIVA Scorecard Year-End 2024"
    
    Автор: Александр Петров, CFP®, специалист по пассивным инвестициям с 12-летним опытом
    
    Дата публикации: 10 марта 2025 года
    Последнее обновление: 2 апреля 2025 года
    
    Примечание: данный материал предоставляется исключительно в информационных целях и не является индивидуальной инвестиционной рекомендацией.
    """
    
    # Создаем SEO-советника для финансовой отрасли
    advisor = SEOAdvisor(industry='finance')
    
    # Анализируем оригинальный контент
    print("\n> Анализ БАЗОВОГО контента:")
    start_time = time.time()
    original_result = advisor.analyze_content(original_content, finance_keywords)
    original_time = time.time() - start_time
    
    print(f"Время анализа: {original_time:.2f} сек")
    print(f"Предсказанная позиция: {original_result.predicted_position:.1f}")
    print(f"Общая оценка E-E-A-T: {original_result.content_metrics.get('overall_eeat_score', 0):.2f}")
    print(f"Плотность ключевых слов: {original_result.keyword_analysis.get('density', 0):.4f}")
    
    # Анализируем улучшенный контент
    print("\n> Анализ УЛУЧШЕННОГО контента:")
    start_time = time.time()
    improved_result = advisor.analyze_content(improved_content, finance_keywords)
    improved_time = time.time() - start_time
    
    print(f"Время анализа: {improved_time:.2f} сек")
    print(f"Предсказанная позиция: {improved_result.predicted_position:.1f}")
    print(f"Общая оценка E-E-A-T: {improved_result.content_metrics.get('overall_eeat_score', 0):.2f}")
    print(f"Плотность ключевых слов: {improved_result.keyword_analysis.get('density', 0):.4f}")
    
    # Сравнение ключевых метрик
    compare_metrics(original_result, improved_result)
    
    # Анализ улучшения позиции
    position_improvement = original_result.predicted_position - improved_result.predicted_position
    position_percent = (position_improvement / original_result.predicted_position) * 100
    
    print(f"\n> Улучшение позиции: с {original_result.predicted_position:.1f} до {improved_result.predicted_position:.1f}")
    print(f"  - Абсолютное улучшение: {position_improvement:.1f} позиций")
    print(f"  - Относительное улучшение: {position_percent:.1f}%")
    
    # Анализ остаточных рекомендаций
    print("\n> Топ-3 рекомендации после улучшений:")
    for category, recommendations in list(improved_result.recommendations.items())[:3]:
        print(f"\nКатегория: {category}")
        for i, rec in enumerate(recommendations[:2], 1):
            print(f"  {i}. {rec}")
    
    print("\n" + "=" * 80)
    print("ИТОГ ТЕСТИРОВАНИЯ: СРАВНЕНИЕ ЗАВЕРШЕНО")
    print("=" * 80)

if __name__ == "__main__":
    main()
